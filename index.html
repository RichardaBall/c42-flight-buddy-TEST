<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>C42 Flight Buddy v2.1</title>
  <style>
    body { font-family: Arial, sans-serif; max-width:600px; margin:auto; padding:20px;
      background:#f5f5f5; color:#333; transition:.3s; }
    body.dark-mode { background:#121212; color:#eee; }
    input { width:100%; padding:10px; font-size:1rem; margin:5px 0; background:#fff;
      border:1px solid #ccc; color:#333; transition:.3s; }
    body.dark-mode input { background:#333; border-color:#555; color:#eee; }
    #results { background:#fff; padding:15px; border-radius:5px; white-space:pre-wrap;
      margin-top:20px; transition:.3s; }
    body.dark-mode #results { background:#222; color:#eee; }
    .ok { color:green; } .bad { color:red; } .warn { color:orange; }
    .highlight { font-weight:bold; }
    footer { text-align:center; font-size:.9rem; color:#666; margin-top:40px;
      transition:.3s; }
    body.dark-mode footer { color:#aaa; }
    #toggle-theme { padding:5px 10px; font-size:.8rem; margin-bottom:15px;
      background:#ddd; border:none; border-radius:4px; cursor:pointer;
      transition:.3s; }
    body.dark-mode #toggle-theme { background:#444; color:#eee; }
  </style>
</head>
<body>
  <h1>C42 Flight Buddy</h1>
  <button id="toggle-theme">Dark Mode</button>
  <p><em>Version: 2.1</em></p>
  <p>Check flight weather at Swansea Airport</p>
  <label for="start">Flight Start (GMT):</label>
  <input type="datetime-local" id="start">
  <label for="duration">Flight Duration (hours):</label>
  <input type="number" id="duration" min="0.5" step="0.5" value="1">
  <div id="results"></div>
  <footer>&copy; 2025 Richard Ball.</footer>

  <script>
    const LAT=51.605, LON=-4.064, API_KEY='81a0d8bef1288c6437560f89b336dd33';
    const elevation=295;

    function estimateDewPoint(t,h) { return t - ((100 - h) / 5); }
    function estimateCloudBase(t,dp) { return Math.round((t - dp) * 400); }
    function highlight(l,v,cond,cls='bad') { return cond ? `${l}<span class="${cls} highlight">${v}</span>` : l+v; }
    function predictRunway(dir) {
      const r={'04':40,'22':220,'10':100,'28':280};
      return Object.entries(r).reduce((a,b)=> {
        const da=Math.min(Math.abs(a[1]-dir),360-Math.abs(a[1]-dir));
        const db=Math.min(Math.abs(b[1]-dir),360-Math.abs(b[1]-dir));
        return da<db?a:b;
      })[0];
    }
    function shearRisk(w,k){const d=k-w;return d>=15?{level:"High",class:"bad"}:d>=10?{level:"Moderate",class:"warn"}:d>=5?{level:"Low",class:"ok"}:{level:"None",class:""};}
    function turbulenceRisk(k){return k>=25?{level:"High",class:"bad"}:k>=20?{level:"Moderate",class:"warn"}:k>=15?{level:"Low",class:"ok"}:{level:"None",class:""};}

    function formatUKDate(d){return d.toUTCString().replace('GMT','GMT');}

    async function fetchVisibility() {
      const r=await fetch('https://tides4fishing.com/uk/wales/swansea/forecast/visibility');
      const t=await r.text();
      const m=t.match(/Today[\s\S]*?Visibility in Swansea.*?(\d+)\s?km/);
      return m?parseInt(m[1])*1000:10000;
    }

    async function checkFlight(){
      const startI=document.getElementById('start').value;
      const dur=parseFloat(document.getElementById('duration').value);
      const res=document.getElementById('results');
      if(!startI||isNaN(dur)||dur<=0){res.innerHTML='<p class="bad">Enter valid start & duration.</p>';return;}
      res.innerHTML='<p>Loading...</p>';
      try {
        const [vis, resp]=await Promise.all([fetchVisibility(),
          fetch(`https://api.openweathermap.org/data/2.5/forecast?lat=${LAT}&lon=${LON}&appid=${API_KEY}&units=metric`).then(r=>r.json())]);
        const data=resp.list;
        const startT=new Date(startI+'Z');
        const endT=new Date(startT.getTime()+dur*3600*1000);
        let pi=data.find(f=>new Date(f.dt*1000)>startT)||data[data.length-1];
        const segs=data.filter(f=>new Date(f.dt*1000)>=pi.dt*1000 && new Date(f.dt*1000)<endT);
        segs.unshift(pi);
        let msg='';
        for(const it of segs){
          const w=it.wind,m=it.main,c=it.clouds,wd=it.weather[0];
          const dp=estimateDewPoint(m.temp,m.humidity), cb=estimateCloudBase(m.temp,dp);
          const windK=(w.speed*1.94384).toFixed(1), gustK=(w.gust? w.gust*1.94384:0).toFixed(1);
          const run = predictRunway(w.deg||0);
          const shear=shearRisk(+windK,+gustK), turb=turbulenceRisk(+gustK);
          msg+=`Time: ${formatUKDate(new Date(it.dt*1000))}\n`;
          msg+=`Temp: ${m.temp.toFixed(1)}°C, DewPt: ${dp.toFixed(1)}°C\n`;
          msg+=highlight('Wind: ',`${w.deg}° @ ${windK} kt`, windK>20)+'\n';
          msg+=highlight('Gusts: ',`${gustK} kt`, gustK>20)+'\n';
          msg+=`Visibility: ${vis>=5000?'>=':''}${vis} m\n`;
          msg+=`Cloud Base: ${cb} ft\n`;
          msg+=`Predicted Runway: ${run}\n`;
          msg+=`Shear Risk: ${shear.level}\n`;
          msg+=`Turbulence Risk: ${turb.level}\n\n`;
        }
        res.innerHTML=`<pre>${msg}</pre>`;
      } catch(e){
        console.error(e);
        res.innerHTML='<p class="bad">Error loading data.</p>';
      }
    }

    window.addEventListener('load',()=>{
      const now=new Date();
      now.setUTCMinutes(0,0,0);
      now.setUTCHours(now.getUTCHours()+1);
      document.getElementById('start').value=now.toISOString().slice(0,16);
      document.getElementById('duration').value=1;
      checkFlight();
      const btn=document.getElementById('toggle-theme'), b= document.body;
      if(localStorage.getItem('theme')==='dark'){
        b.classList.add('dark-mode');
        btn.textContent='Light Mode';
      }
      btn.addEventListener('click',()=>{
        const dark=b.classList.toggle('dark-mode');
        btn.textContent=dark?'Light Mode':'Dark Mode';
        localStorage.setItem('theme',dark?'dark':'light');
      });
    });
    document.getElementById('start').addEventListener('change',checkFlight);
    document.getElementById('duration').addEventListener('input',checkFlight);
  </script>
</body>
</html>
